# CaFFlow

CaFFlow is a Python framework for acquisition and analysis of single-,
two-photon calcium imaging and experimental animal's behavior data.
This project is intended to be used for acquisition of video data stream(s) generated
by [Miniscope](http://miniscope.org) miniature fluorescence microscope and subsequent
(offline and/or online) analysis of the acquired data.
Practically however, it can be used for processing of wider range of frame streams,
such as animal's behavior only, batch image/video editing etc.

### Repository layout

CaFFlow consist of two main parts - framework-side and user-side scripts.
The framework-side part is a self-contained set of Python classes/functions representing
building blocks common for all recordings/experiments conducted in a Lab.
The user-side part is a set of Python scripts adapted for each experiment.
The framework is extended by developer(s), and never changed by user(s);
it has a strict set of external dependencies and guarantied backward compatibility.


- __examples__ - examples of the user-side scripts. Each script demonstrate usage of particular set of features provided by the mendouscopy framework.
- __mendouscopy__ - framework-side code related to analysis of the acquired calcium imaging and behavior data.
- __mstools__ - framework-side GUI applications for video stream(s) preview and recording of video frames generated by [Miniscope](http://miniscope.org) hardware and/or common video cameras.
- __unit_test__ - scripts for testing readiness of your Python environment to be used with the CaFFlow.


### Supported OS

- Windows (primarily).
- Any OS for which Python and all required packages available (optionally).


### Installation

__FIXME: this is short description for those who already familiar with Python/Conda.__

Download and install a command line interface based `git` client, such as
[Git for Windows](https://git-scm.com/download/win) if you do not already have it installed.

Install/activate [Git Large File Storage](https://git-lfs.github.com/) extension.

_Windows:_

- launch the `git` client application and run: `$ git lfs install`

_MacOS:_

- if you use Homebrew, open terminal and run: `$ brew install git-lfs`
- if you use MacPorts, open terminal and run: `$ port install git-lfs`

_FreeBSD:_

- Open terminal and run: `$ pkg install git-lfs && git lfs install`

Change directory `(cd)` to the place where you plan to keep CaFFlow and clone this repository:

`$ git clone https://github.com/DenisPolygalov/CaFFlow.git`

Download and install [Miniconda](https://docs.conda.io/en/latest/miniconda.html) if you don't have it installed already.

Create and activate new 'Conda environment':

_Windows:_

Launch 'Anaconda Prompt' from Windows Start Menu and type:

`(base)> conda create -n cafflow`

`(base)> conda activate cafflow`

_MacOS:_

Launch the 'Terminal' application and type:

`$ source miniconda3/bin/activate`

`(base)$ conda create -n cafflow`

`(base)$ source activate cafflow`

Install necessary Python packages (the command syntax is common across Windows/MacOS/FreeBSD):

`(cafflow)> conda install opencv numpy pandas scipy scikit-image`

The set of packages above is sufficient to run analysis without visualization (on a headless server for example) and GUI applications.

For GUI-based applications - install PyQt package:

`(cafflow)> conda install pyqt`

For video encoding/decoding support the lossless video codec (FFV1)
must be installed and registered globally, at your operating system level
(i.e. as a COM DLL in the case of Windows). FFV1 video __encoding__ is supported by
OpenCV distributed via the `conda` installer. FFV1 video __decoding__ support
might be already available on your PC (installed for example by a third-party
application) so it is necessary to check it's presence.
In order to do so run the `examples/sXX_capture_video.py` script:

`(cafflow)> cd CaFFlow\examples`

`(cafflow)> python sXX_capture_video.py`

and examine it's output. The script will try to capture a chunk of video
stream from default video camera (must be connected in advance obviously),
encode the video by using FFV1 codec provided by OpenCV and write encoded video
into a file called *'captured_lossless_video.avi'* located in the same directory.
If the file was created, have non-zero size and you can play it's content
by using common video-player software then you have FFV1 decoding support already installed.
If the file is broken or not created at all you can try to install 
[LAV Filters](https://github.com/Nevcairiel/LAVFilters) - 
Open-Source DirectShow Media Splitter and Decoders binary package
for Windows** 
from [here](https://github.com/Nevcairiel/LAVFilters/releases)
, then restart your PC and repeat the test.

** Installing FFV1 video encoding/decoding support for other OSes is outside of the scope of this project.

The next step is to test your Python environment:

`(cafflow)> cd CaFFlow`

`(cafflow)> python -m unittest discover unit_test`

Read Python scripts located in the __examples__ directory, execute them and adjust for your purpose.
Note that all example scripts are intended to be executed from __*inside*__ of the __examples__ directory.
